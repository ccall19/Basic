# 01｜IP 与路由：30 秒建立“包往哪走”的直觉

你在服务器上排网络问题，**80% 的时间都在确认 3 件事**：
1) 本机有什么 IP？在什么网段？
2) 默认网关是谁？到目标地址走哪条路由？
3) 是否存在“多网卡/多默认路由/策略路由”导致走错出口？

---

## 1. 30 秒检查清单（先做这个再谈别的）

1) 看接口与 IP：
- `ip -br link`
- `ip -br addr`

2) 看路由表（重点看 default）：
- `ip route`
- IPv6：`ip -6 route`

3) 看“到某个目标 IP 实际怎么走”（最有用的一条命令）：
- `ip route get 1.1.1.1`
- `ip route get <目标IP>`

你要能从输出里读出：`dev`（走哪个网卡）、`src`（源 IP）、`via`（下一跳网关）。

---

## 2. 你必须能解释的 3 个概念

### 2.1 “同网段”与默认网关
- 如果目标 IP **在本机直连网段**：通常不需要网关，直接 ARP 找对方 MAC。
- 如果目标 IP **不在直连网段**：必须走默认网关（或更具体的静态路由）。

### 2.2 最长前缀匹配（路由选择规则）
- 有多条路由都能匹配目标时，**前缀更长**（更具体）的优先。

### 2.3 多网卡/多默认路由：新手最容易踩
典型症状：
- `ping` 偶尔通、偶尔不通
- 业务“能出不能回”或“回包走错口”
- 抓包发现请求从 eth0 出去，回包从 eth1 进来（或根本回不来）

快速判断：
- `ip route | grep '^default' -n`
- `ip rule`（如果有策略路由）

---

## 3. 常用命令速查（够用版）

### 3.1 看本机地址
- `ip addr show`
- 只看摘要：`ip -br addr`

### 3.2 看路由
- `ip route`
- `ip route get <dst>`
- 看某张路由表（有策略路由时）：`ip route show table main`

### 3.3 诊断“回不来”的经典开关：rp_filter
多网卡/多出口时，`rp_filter` 可能把“看起来不对称”的包丢掉。
- 查看：`sysctl net.ipv4.conf.all.rp_filter`、`sysctl net.ipv4.conf.default.rp_filter`

注意：是否要关/调成 loose 取决于你的网络设计；在云上多网卡/容器场景更常见。

---

## 4. 典型故障怎么最快定位

### 4.1 “能访问域名但访问 IP 不行 / 或反过来”
- 先把 DNS 和路由拆开：
  - `ip route get <对端IP>`
  - DNS 另查（见 DNS 笔记）

### 4.2 “同网段不通”
- 通常不是路由，是 ARP/二层（见 ARP 笔记）：
  - `ip neigh`

### 4.3 “只有某个网段不通”
- 多半缺静态路由 / 云路由表 / ACL：
  - `ip route get <那个网段里的一个IP>`

---

## 5. 一句话心法

- 任何网络问题，先回答：**我的包要去哪里（dst），从哪块网卡出去（dev），源 IP 是谁（src），下一跳是谁（via）**。
