# 03｜ss：端口监听 & TCP 状态（服务器排障必备）

`ss` 用来回答两件最重要的问题：
1) 服务端到底有没有监听端口？是哪个进程？
2) 连接处于什么 TCP 状态？队列有没有堆积？

---

## 1. 30 秒检查清单

1) 服务是否在监听：
- `ss -lntup`

2) 指定端口（例如 8080）：
- `ss -lntup '( sport = :8080 )'`

3) 看连接状态与队列（重点看 Recv-Q / Send-Q）：
- `ss -antp | head`
- 按状态汇总：`ss -s`

---

## 2. 最常用的 5 条命令（直接记住）

- 所有 TCP 监听：`ss -lnt`
- 监听 + 进程：`ss -lntp`
- 所有 TCP 连接：`ss -ant`
- UDP socket：`ss -uapn`
- 汇总统计：`ss -s`

提示：
- `-l` listening，`-n` 不解析名字（更快），`-p` 显示进程，`-t/-u` tcp/udp，`-a` all。

---

## 3. 必须能看懂的 TCP 状态（够排障）

### 3.1 建连相关
- `SYN-SENT`：客户端发了 SYN，等对端回应（常见：对端/路由/防火墙问题）
- `SYN-RECV`：服务端收到了 SYN 并回了 SYN+ACK，等客户端 ACK（常见：客户端/回程/安全组问题）

### 3.2 连接关闭相关
- `TIME-WAIT`：主动关闭方等待（大量出现不一定是问题，但可能说明短连接过多）
- `CLOSE-WAIT`：对端发 FIN 了，本端应用没 close（**常见应用 bug/连接泄漏**）

### 3.3 正常
- `ESTAB`：已建立连接

---

## 4. 队列怎么看（不需要背内核参数，但要会读现象）

`ss` 输出中的：
- `Recv-Q`：应用还没来得及读的数据 / 或 backlog 堆积
- `Send-Q`：未被对端确认的发送数据 / 或发送缓冲堆积

经验判断：
- 监听行的 `Recv-Q` 持续增长：可能 accept backlog 堆积（来连接太多或应用 accept 慢）
- ESTAB 行 `Send-Q` 很大：对端收不动/网络丢包/拥塞

---

## 5. “端口不通”最快定位路径

1) 本机是否监听：`ss -lntp '( sport = :PORT )'`
2) 防火墙/安全组是否放行（见防火墙笔记）
3) 抓包看 SYN 是否到达（见 tcpdump 笔记）

---

## 6. 一句话心法

- 排“端口不通”，先看 `ss -lntp`；排“连接慢/堆积”，再看 `ss -antp` 和队列。
