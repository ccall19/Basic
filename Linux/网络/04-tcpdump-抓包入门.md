# 04｜tcpdump 抓包入门：用最少命令把问题“拍扁”

抓包的目标不是“看懂一切”，而是用最小过滤器回答：
- 包有没有到我这台机？
- 我有没有回？回包有没有出去？
- TCP 三次握手卡在哪一步？

---

## 1. 抓包前的 10 秒准备

1) 先确认抓哪张网卡：
- `ip -br addr`
- 如果不确定，从路由推断：`ip route get <dst>`（看 `dev`）

2) 再确认端口与进程：
- `ss -lntp '( sport = :PORT )'`

---

## 2. 3 条“万能抓包命令”（直接抄）

### 2.1 抓某端口的 TCP（双向）
- `tcpdump -ni <网卡> tcp port 443`

### 2.2 抓某个对端 IP（所有协议）
- `tcpdump -ni <网卡> host <对端IP>`

### 2.3 抓 HTTP/应用前先抓三次握手
- `tcpdump -ni <网卡> 'tcp[tcpflags] & (tcp-syn|tcp-ack|tcp-fin|tcp-rst) != 0'`

---

## 3. 最小读包法：三次握手你只需要认出 4 个东西

- `S`：SYN
- `S.`：SYN+ACK
- `.`：ACK
- `R`：RST（被拒绝/端口不通/中间设备拒绝）

典型场景：

### 3.1 只看到 SYN 出去，看不到 SYN+ACK 回来
- 可能：对端没开、路由不通、安全组/防火墙丢包

### 3.2 服务端看到 SYN 进来，也回了 SYN+ACK，但看不到 ACK
- 可能：回程被挡/客户端收不到/中间设备丢包

### 3.3 看到 RST
- 可能：对端主动拒绝、端口没监听、（少见）中间设备发 RST

---

## 4. 保存 pcap（非常推荐）

- `tcpdump -ni <网卡> host <对端IP> -w /tmp/cap.pcap`

然后把文件拿到本机 Wireshark 看，会快很多。

---

## 5. 常见抓包坑

- 抓错网卡（尤其多网卡/容器/bridge）
- 忘记加 `-n` 导致解析 DNS 慢、输出延迟
- 线上直接抓 `-i any` 输出太大（建议先用 host/port 过滤）

---

## 6. 一句话心法

- “端口不通/连接慢”时，抓包只要搞清：**SYN 到没到、SYN+ACK 回没回、ACK 到没到**。
