# Docker 常用命令总结

> 适用场景：日常开发/排障。命令以 Docker CLI 为主，Compose 放在后半部分。
> 约定：`IMAGE` 镜像名（可含 tag），`CONTAINER` 容器名或 ID。

学习目标（读完你应该能做到）：

- 用 `docker run/ps/logs/exec` 完成一次容器的启动、查看、排障与进入操作
- 理解 `-p/-e/-v/--rm` 这些高频参数在干什么
- 会用 `docker compose up/down/logs/exec` 管理一个多容器环境

---

## 0. 帮助与信息

```bash
docker --version
docker version
docker info

docker help
docker <command> --help
```

---

## 1. 镜像（image）

### 1.1 拉取 / 查看 / 删除

```bash
docker pull IMAGE[:TAG]
docker images
docker image ls

docker rmi IMAGE|IMAGE_ID
docker image prune              # 清理 dangling 镜像
docker image prune -a           # 清理未被使用的镜像（慎用）
```

### 1.2 构建

```bash
docker build -t IMAGE:TAG .

# 指定 Dockerfile
docker build -f path/Dockerfile -t IMAGE:TAG .

# 不使用缓存
docker build --no-cache -t IMAGE:TAG .

# 传入构建参数
docker build --build-arg KEY=VALUE -t IMAGE:TAG .
```

补充：

- `-f path/Dockerfile`：指定要使用的 Dockerfile（不写默认用上下文目录下的 `Dockerfile`）。
- 最后的 `.`：构建上下文（决定 `COPY/ADD` 能访问的文件范围，受 `.dockerignore` 影响）；**Dockerfile 路径与上下文可以不同**。

### 1.3 镜像详情 / 历史 / 搜索

```bash
docker inspect IMAGE|IMAGE_ID
docker history IMAGE|IMAGE_ID
```

---

## 2. 容器（container）生命周期与运行

### 2.1 创建并运行（最常用）

```bash
# 前台运行（Ctrl+C 结束）
docker run --rm IMAGE

# 后台运行（-d）并命名（--name）
docker run -d --name myapp IMAGE

# 端口映射：宿主机:容器
docker run -d --name web -p 8080:80 IMAGE

# 环境变量
docker run -d --name app -e ENV=prod IMAGE

# 挂载（volume / bind）
docker run -d --name app -v /host/path:/container/path IMAGE

# 设置工作目录
docker run -it --rm -w /work -v "${PWD}":/work IMAGE

# 交互式终端
docker run -it --rm IMAGE sh
```

说明：`--rm` 表示**容器退出后自动删除容器本身**（不删镜像；挂载的命名卷一般也不删）。适合一次性运行/临时排查。

常见参数速记：

- `-d` 后台运行
- `--name xxx` 指定容器名
- `--rm` 退出后自动删除容器
- `-p 8080:80` 端口映射
- `-e K=V` 环境变量
- `-v host:container` 挂载
- `-it` 交互式 + 分配 TTY
- `--restart=always|unless-stopped` 重启策略

### 2.2 查看运行状态

```bash
docker ps                    # 运行中的容器
docker ps -a                 # 所有容器
docker container ls
docker container ls -a

docker stats                 # 资源监控（实时）
docker top CONTAINER         # 查看容器内进程
```

### 2.3 启动 / 停止 / 重启 / 删除

```bash
docker start CONTAINER
docker stop CONTAINER
docker restart CONTAINER

docker kill CONTAINER        # 强制停止（发 SIGKILL）

docker rm CONTAINER
docker rm -f CONTAINER       # 强制删除（会先停止）
docker container prune       # 清理已停止容器
```

---

## 3. 进入容器与执行命令

### 3.1 exec（推荐）

```bash
docker exec -it CONTAINER sh
docker exec -it CONTAINER bash

# 直接执行命令
docker exec CONTAINER ls -la
```

### 3.2 attach（不常用，谨慎）

```bash
docker attach CONTAINER
```

`attach` 会连到主进程的标准输入输出；主进程退出容器就退出，且很容易误操作。

---

## 4. 日志与排障

```bash
docker logs CONTAINER
docker logs -f CONTAINER                 # 跟随
docker logs --tail 200 CONTAINER         # 只看最后 N 行
docker logs --since 10m CONTAINER        # 最近 10 分钟
docker logs --timestamps CONTAINER       # 带时间戳

docker inspect CONTAINER                 # 看配置、挂载、网络、环境变量等
```

排障常用组合：

- 容器起不来：`docker ps -a` → `docker logs` → `docker inspect`
- 端口不通：检查 `-p` 映射、容器内监听地址（0.0.0.0 vs 127.0.0.1）、网络模式

---

## 5. 文件拷贝

```bash
# 宿主机 -> 容器
docker cp /host/file CONTAINER:/path/in/container

# 容器 -> 宿主机
docker cp CONTAINER:/path/in/container /host/dir
```

---

## 6. 网络（network）

### 6.1 查看 / 创建 / 删除

```bash
docker network ls
docker network inspect NETWORK

docker network create mynet
docker network rm mynet
docker network prune
```

### 6.2 连接网络

```bash
docker run -d --name api --network mynet IMAGE

docker network connect mynet CONTAINER
docker network disconnect mynet CONTAINER
```

提示：同一自定义 bridge 网络内，容器可用「容器名」互相解析（内置 DNS）。

---

## 7. 数据卷（volume）

### 7.1 查看 / 创建 / 删除

```bash
docker volume ls
docker volume inspect VOLUME

docker volume create myvol
docker volume rm myvol
docker volume prune
```

### 7.2 使用 volume

```bash
docker run -d --name db -v myvol:/var/lib/mysql mysql:8
```

---

## 8. 清理与磁盘占用

```bash
docker system df

docker system prune                  # 清理：停止容器、dangling 镜像、未用网络、构建缓存
docker system prune -a               # 额外清理未使用镜像（慎用）
docker builder prune                 # 清理 build cache
```

建议：线上/重要环境谨慎使用 `-a`。

---

## 9. Tag / Push / 私有仓库

```bash
docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
docker login
docker push IMAGE[:TAG]
docker logout
```

---

## 10. 导入/导出（离线交付常用）

### 10.1 镜像：save / load

```bash
docker save -o image.tar IMAGE:TAG
docker load -i image.tar
```

### 10.2 容器：export / import（不含镜像历史与层信息）

```bash
docker export -o container.tar CONTAINER
docker import container.tar NEW_IMAGE:TAG
```

一般交付镜像用 `save/load`；`export/import` 更像“打包文件系统快照”。

---

## 11. 常见 run 模板（可直接套用）

### 11.1 Nginx

```bash
docker run -d --name nginx -p 8080:80 nginx:alpine
```

### 11.2 MySQL

```bash
docker run -d --name mysql \
	-p 3306:3306 \
	-e MYSQL_ROOT_PASSWORD=pass \
	-v mysql_data:/var/lib/mysql \
	mysql:8
```

### 11.3 Redis

```bash
docker run -d --name redis -p 6379:6379 redis:7
```

---

## 12. Docker Compose（多容器编排）

> 说明：新版本一般用 `docker compose ...`（空格形式），旧版为 `docker-compose ...`。

```bash
docker compose version

docker compose up -d              # 启动（后台）
docker compose up                 # 前台（便于看日志）
docker compose down               # 停止并移除容器/网络
docker compose down -v            # 同时删除匿名卷（谨慎）

docker compose ps
docker compose logs -f
docker compose exec SERVICE sh
docker compose restart SERVICE
docker compose pull
docker compose build
```

常用技巧：

- 只重建某个服务：`docker compose build <service>`
- 只重启某个服务：`docker compose restart <service>`

---

## 13. 速查（最常用 TOP10）

```bash
docker ps
docker ps -a
docker images
docker run -d --name xxx -p 8080:80 IMAGE
docker logs -f xxx
docker exec -it xxx sh
docker stop xxx
docker rm xxx
docker rmi IMAGE
docker system df
```
