# Docker 网络与端口（必备）

学习目标（读完你应该能做到）：

- 理解 `-p host:container` 的含义，以及为什么容器要监听 `0.0.0.0`
- 能创建/使用自定义网络，让容器通过名字互相访问
- 遇到“映射端口但访问不到”时能按 checklist 快速定位

## 1. 基本概念

- **网络命名空间**：默认每个容器有独立 network namespace
- **网络驱动**（常见）：
  - `bridge`：默认单机网络（最常用）
  - `host`：与宿主机共用网络栈（Linux 常用；macOS/Windows 行为不同）
  - `none`：无网络
- **容器 DNS**：自定义 bridge 网络内可用容器名互相解析

---

## 2. 端口映射的本质

`-p 8080:80` 表示把**宿主机** 8080 转发到 **容器** 80。

常见写法：

- `-p 8080:80`：绑定所有宿主机网卡
- `-p 127.0.0.1:8080:80`：只允许本机访问（更安全）
- `-P`：把 Dockerfile 里 `EXPOSE` 的端口随机映射到宿主机

补充：在 macOS/Windows 的 Docker Desktop 上，Docker 运行在虚拟机里；你依然可以通过 `-p` 在宿主机访问容器服务，但一些 Linux 下的网络细节（例如 `--network host` 的语义）会不同。

---

## 3. 常用命令

```bash
docker network ls
docker network inspect <network>

docker network create mynet

docker run -d --name a --network mynet nginx:alpine
docker run -d --name b --network mynet nginx:alpine
```

---

## 4. 排障 checklist（非常实用）

### 4.1 宿主机访问不到容器服务

按顺序排：

1) 容器在不在：
- `docker ps`

2) 容器是否监听端口：
- `docker logs <container>`（看是否启动失败）
- `docker exec -it <container> sh` → 在容器内检查服务是否起来

3) 端口映射是否正确：
- `docker port <container>`（查看映射）

4) 服务监听地址是否正确：
- Web 服务必须监听 `0.0.0.0`，不能只监听 `127.0.0.1`

5) 是否被绑定到 127.0.0.1：
- 如果你用 `-p 127.0.0.1:8080:80`，局域网设备访问不到是正常的

### 4.2 容器之间互相访问失败

1) 是否在同一个网络：
- `docker inspect <container>` → `Networks`

2) 优先使用自定义 bridge 网络：
- 自定义网络能用容器名做 DNS

---

## 5. macOS 特殊说明（简要）

macOS 的 Docker Desktop 运行在虚拟机里，网络/host 模式一些细节与 Linux 不同；单机开发建议优先：

- `bridge + -p` 端口映射
- Compose 自定义网络
