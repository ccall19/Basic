# Docker 日志与轮转（避免磁盘被打爆）

学习目标（读完你应该能做到）：

- 知道 `docker logs` 看的是 stdout/stderr，以及为什么日志会越积越大
- 会查看当前日志驱动，并为 `json-file` 配置滚动策略
- 会在 Compose 里配置 logging options，避免单机磁盘被日志占满

## 1. 你需要先知道的 3 件事

1) `docker logs` 读的是**容器的 stdout/stderr**（不是应用自己的文件日志）。

2) 默认日志驱动常见是 `json-file`：日志会落在宿主机（Docker Desktop 则在其 VM）中，**如果不轮转，可能无限增长**。

3) 生产环境通常会把日志交给集中式系统（ELK / Loki / Cloud Logging 等），容器侧只负责输出到 stdout。

---

## 2. 快速查看：当前使用的日志驱动

### 2.1 全局默认

```bash
docker info | grep -i "Logging Driver" -n
```

### 2.2 某个容器

```bash
docker inspect <container> --format '{{.HostConfig.LogConfig.Type}}'
```

（不同驱动的可配项不同，下面以最常见的 `json-file` 为主。）

---

## 3. `docker logs` 常用姿势

```bash
docker logs <container>
docker logs -f <container>
docker logs --tail 200 <container>
docker logs --since 10m <container>
docker logs --timestamps <container>
```

提示：如果你用 `--rm` 跑临时容器，容器退出后会被删除，就不方便事后 `docker logs` 了。

---

## 4. json-file 日志轮转（最常用、最容易忽略）

### 4.1 运行容器时指定轮转（推荐）

```bash
docker run -d --name app \
  --log-driver json-file \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  IMAGE
```

含义：

- `max-size=10m`：单个日志文件最大 10MB
- `max-file=3`：最多保留 3 个文件（滚动）

### 4.2 Docker 全局默认轮转（daemon 配置）

> 不同机器/环境配置位置不同；Docker Desktop 与 Linux 原生路径也不同。
> 这里给出“你要配什么字段”的通用模板。

`daemon.json`（示意）：

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

改完需要重启 Docker daemon 才生效。

---

## 5. Compose 中如何设置日志轮转

```yaml
services:
  app:
    image: your-app:latest
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
```

---

## 6. 常见坑与建议

- **日志写文件 vs stdout**：容器里如果把日志写到文件，`docker logs` 看不到；更推荐输出到 stdout，再由平台采集。
- **日志量爆炸**：
  - 检查是否有循环打印、debug 模式、健康检查误配导致大量输出
- **磁盘爆了怎么查**：
  - `docker system df`
  - 再结合容器数量、服务日志量判断是否需要轮转或接入集中日志

---

## 7. 什么时候考虑更换日志驱动

- 单机开发：`json-file` + 轮转通常够用
- 生产：更常见是接入宿主机/集群的日志方案（例如 `journald` 或专门的日志采集 sidecar/agent），避免单机堆积
