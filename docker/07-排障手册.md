# Docker 排障手册（从现象到定位）

学习目标（读完你应该能做到）：

- 遇到“起不来/连不上/磁盘爆/慢”能按固定顺序收集信息
- 会用 `docker ps -a / logs / inspect / port` 快速缩小问题范围
- 能写出一份可复用的排障信息模板（方便问人/提 issue）

> 目标：遇到问题先按套路把信息收集齐，再下结论。

---

## 1. 容器起不来 / 一直重启

1) 看容器状态

```bash
docker ps -a
```

2) 看退出码与日志

```bash
docker logs --tail 200 <container>
docker inspect <container>
```

3) 常见原因

- 配置/环境变量缺失（应用直接退出）
- 端口被占用（宿主机 `-p` 失败）
- 依赖服务不可用（DB/Redis 未就绪）
- 权限问题（写目录失败，尤其是 bind mount）

---

## 2. 端口映射后仍访问不到

快速判断：

- 宿主机端口是否映射成功：`docker port <container>`
- 容器内服务是否监听 `0.0.0.0`：进入容器查看启动参数/日志
- 是否只绑定了 127.0.0.1：`-p 127.0.0.1:...`

---

## 3. 容器间互相访问失败

- 用自定义网络（Compose 默认就会建）
- 用服务名/容器名访问
- `docker inspect` 看是否在同一 network

---

## 4. 磁盘占用飙升

```bash
docker system df
```

常见大头：

- 未清理的镜像与构建缓存
- Volume（数据库数据长期累积）
- 容器日志（json-file driver 默认会增长）

---

## 5. 性能慢（构建慢 / IO 慢）

- 构建慢：优化缓存层、减少上下文、写 `.dockerignore`
- macOS bind mount 小文件多会慢：能用 volume 的尽量用 volume

---

## 6. 信息收集模板（提问/记录用）

把下面这段输出粘贴下来，基本能定位 80% 问题：

```text
- docker version:
- docker info:
- 复现步骤：
- 期望结果：
- 实际结果：
- docker ps -a:
- docker logs --tail 200 <container>:
- docker inspect <container> (NetworkSettings/Mounts/State):
```
